<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Multiâ€‘QR Scanner (html5â€‘qrcode)</title>
  <meta name="theme-color" content="#141b34">
  <link rel="manifest" href="manifest.json">
  <style>
    :root {
      --bg: #0b1020; --card:#141b34; --muted:#a8b3cf; --text:#e6ecff; --accent:#7aa2ff;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; background: var(--bg); color: var(--text); }
    header { padding: 20px; display:flex; gap:14px; align-items: center; justify-content: space-between; flex-wrap:wrap; border-bottom:1px solid #20284a; }
    h1 { font-size: 20px; margin:0; letter-spacing:.2px; }
    .wrap { display:grid; grid-template-columns: 1fr 1fr; gap:20px; padding: 20px; }
    @media (max-width: 980px){ .wrap { grid-template-columns: 1fr; } }

    .card { background: var(--card); border:1px solid #20284a; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .card h2 { margin:0 0 12px 0; font-size:16px; color:var(--muted); }
    .card .body { padding:16px; }

    #reader { width: 100%; min-height: 420px; overflow: hidden; border-radius: 12px; }

    .controls { display:flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 12px; }
    .controls > * { min-height: 36px; }

    select, input[type="number"], input[type="text"], input[type="file"], button {
      background:#0e1631; color:var(--text); border:1px solid #233163; border-radius: 10px; padding: 8px 10px; outline:none; font-size: 14px;
    }
    button { background: linear-gradient(180deg,#2a3d7a,#1f2f61); cursor:pointer; }
    button.secondary { background:#0e1631; }
    button.danger { background:#5a2031; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .badge { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; background:#0e1631; border:1px solid #233163; color:var(--muted); font-size:12px; }

    table { width:100%; border-collapse: collapse; }
    thead th { text-align:left; font-weight:600; color:var(--muted); border-bottom:1px solid #27335f; padding:10px; position: sticky; top:0; background: var(--card); }
    tbody td { border-bottom:1px solid #22305c; padding:10px; vertical-align: top; }
    tbody tr:hover { background: rgba(122,162,255,0.06); }
    .value { word-break: break-word; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; }

    .footer-note { color: var(--muted); font-size:12px; margin-top: 10px; }
  </style>
  <!-- html5-qrcode CDN -->
  <script src="./html5-qrcode.min.js"></script>
</head>
<body>
  <header>
    <h1>Multiâ€‘QR Scanner</h1>
    <div class="controls">
      <select id="cameraSelect" title="Select camera"></select>
      <label class="badge"><input id="dedupe" type="checkbox" checked style="accent-color:#7aa2ff;"> dedupe</label>
      <label class="badge"><input id="beep" type="checkbox" checked style="accent-color:#7aa2ff;"> beep</label>
      <label class="badge">FPS <input id="fps" type="number" min="1" max="60" value="12" style="width:70px;margin-left:6px"></label>
      <label class="badge">QR box <input id="qrbox" type="number" min="100" max="700" value="280" style="width:80px;margin-left:6px"></label>
      <button id="startBtn">Start</button>
      <button id="pauseBtn" class="secondary" disabled>Pause</button>
      <button id="resumeBtn" class="secondary" disabled>Resume</button>
      <button id="stopBtn" class="danger" disabled>Stop</button>
      <button id="torchBtn" class="secondary" disabled>Toggle Torch</button>
      <input id="filePicker" type="file" accept="image/*" multiple />
    </div>
  </header>

  <div class="wrap">
    <section class="card">
      <div class="body">
        <h2>Live camera</h2>
        <div id="reader"></div>
        <div class="footer-note">Grant camera permission, choose the correct lens (rear lens on mobile typically ends with "+back"), then press <strong>Start</strong>.</div>
      </div>
    </section>

    <section class="card">
      <div class="body">
        <h2>Scanned results</h2>
        <div class="controls" style="margin-bottom:6px">
          <button id="copyBtn" class="secondary" disabled>Copy all</button>
          <button id="exportBtn" class="secondary" disabled>Export CSV</button>
          <button id="clearBtn" class="secondary" disabled>Clear</button>
          <span class="badge" id="countBadge">0 unique</span>
        </div>
        <div style="max-height: 420px; overflow:auto; border:1px solid #22305c; border-radius:12px;">
          <table id="results">
            <thead>
              <tr><th>#</th><th>Timestamp</th><th>Value</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="footer-note">You can also drop image files here to scan them.</div>
      </div>
    </section>
  </div>

<script>
// --- existing QR scanner script ---
(function(){
  const cameraSelect = document.getElementById('cameraSelect');
  const startBtn = document.getElementById('startBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const resumeBtn = document.getElementById('resumeBtn');
  const stopBtn = document.getElementById('stopBtn');
  const torchBtn = document.getElementById('torchBtn');
  const filePicker = document.getElementById('filePicker');
  const dedupeChk = document.getElementById('dedupe');
  const beepChk = document.getElementById('beep');
  const fpsInput = document.getElementById('fps');
  const qrboxInput = document.getElementById('qrbox');
  const tableBody = document.querySelector('#results tbody');
  const countBadge = document.getElementById('countBadge');
  const copyBtn = document.getElementById('copyBtn');
  const exportBtn = document.getElementById('exportBtn');
  const clearBtn = document.getElementById('clearBtn');

  const readerId = 'reader';
  const html5Qr = new Html5Qrcode(readerId, { verbose: false });

  let running = false;
  let paused = false;
  let torchOn = false;
  let currentDeviceId = null;
  let seen = new Set();
  let rows = []; // {tsISO, value}

  function fmtTS(d){
    return d.toLocaleString();
  }

  function bumpCount(){
    const n = seen.size;
    countBadge.textContent = n + ' unique';
    copyBtn.disabled = exportBtn.disabled = clearBtn.disabled = (rows.length === 0);
  }

  function addRow(value){
    const now = new Date();
    const ts = fmtTS(now);
    const tr = document.createElement('tr');
    const idx = rows.length + 1;
    tr.innerHTML = `<td>${idx}</td><td>${ts}</td><td class="value">${escapeHtml(value)}</td>`;
    tableBody.prepend(tr);
    rows.push({ tsISO: now.toISOString(), value });
    bumpCount();
  }

  function escapeHtml(str){
    return str.replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s]));
  }

  function beep(){
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = 'square';
      o.frequency.value = 880;
      o.connect(g); g.connect(ctx.destination);
      g.gain.setValueAtTime(0.001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.01);
      o.start();
      setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.15); o.stop(ctx.currentTime + 0.16); }, 120);
    }catch(e){ /* ignore */ }
  }

  async function listCameras(){
    try{
      const cams = await Html5Qrcode.getCameras();
      cameraSelect.innerHTML = '';
      cams.forEach((c,i)=>{
        const opt = document.createElement('option');
        opt.value = c.id; opt.textContent = c.label || `Camera ${i+1}`;
        cameraSelect.appendChild(opt);
      });
      if (cams.length) currentDeviceId = cams[0].id;
    } catch(err){
      console.error(err);
      alert('Could not list cameras. Ensure you granted camera permission and are using a secure origin (https:// or localhost).');
    }
  }

  async function start(){
    if(running) return;
    currentDeviceId = cameraSelect.value || currentDeviceId;
    const fps = Math.min(Math.max(parseInt(fpsInput.value,10)||12,1),60);
    const qrbox = Math.min(Math.max(parseInt(qrboxInput.value,10)||280,100),700);

    const config = {
      fps,
      qrbox: { width: qrbox, height: qrbox },
      aspectRatio: 1.0,
      rememberLastUsedCamera: true,
      experimentalFeatures: { useBarCodeDetectorIfSupported: true },
      formatsToSupport: [
  Html5QrcodeSupportedFormats.QR_CODE,
  Html5QrcodeSupportedFormats.CODE_128,
  Html5QrcodeSupportedFormats.EAN_13
]
    };

    try{
      await html5Qr.start({ deviceId: { exact: currentDeviceId } }, config, onScanSuccess, onScanFailure);
      running = true; paused = false;
      startBtn.disabled = true; pauseBtn.disabled = false; stopBtn.disabled = false; resumeBtn.disabled = true; torchBtn.disabled = false;
    }catch(err){
      console.error(err);
      alert('Failed to start camera: ' + err);
    }
  }

  function onScanSuccess(decodedText, decodedResult){
    const value = String(decodedText);
    if (dedupeChk.checked){
      if (seen.has(value)) return; // ignore duplicates
      seen.add(value);
    }
    addRow(value);
    if (beepChk.checked) beep();
  }

  function onScanFailure(){ /* ignore frame failures for speed */ }

  async function pause(){
    if (!running || paused) return;
    try{ await html5Qr.pause(true); paused = true; } catch(e){ console.warn(e); }
    pauseBtn.disabled = true; resumeBtn.disabled = false;
  }

  async function resume(){
    if (!running || !paused) return;
    try{ await html5Qr.resume(); paused = false; } catch(e){ console.warn(e); }
    pauseBtn.disabled = false; resumeBtn.disabled = true;
  }

  async function stop(){
    if (!running) return;
    try{ await html5Qr.stop(); await html5Qr.clear(); } catch(e){ console.warn(e); }
    running = false; paused = false; torchOn = false;
    startBtn.disabled = false; pauseBtn.disabled = true; resumeBtn.disabled = true; stopBtn.disabled = true; torchBtn.disabled = true;
  }

  async function toggleTorch(){
    // Try to toggle via applyVideoConstraints (supported on some devices)
    try{
      torchOn = !torchOn;
      await html5Qr.applyVideoConstraints({ advanced: [{ torch: torchOn }] });
    }catch(e){
      alert('Torch control not supported on this device/browser.');
      torchOn = false;
    }
  }

  function copyAll(){
    const text = rows.map(r=>r.value).join('\n');
    navigator.clipboard.writeText(text).then(()=>{
      toast('Copied ' + rows.length + ' rows');
    },()=>{ alert('Copy failed'); });
  }

  function exportCSV(){
    const header = ['index','timestamp_iso','value'];
    const lines = [header.join(',')];
    rows.forEach((r,i)=>{
      lines.push([i+1, r.tsISO, '"' + r.value.replaceAll('"','""') + '"'].join(','));
    });
    const blob = new Blob([lines.join('\n')+'\n'], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'), { href:url, download: 'qr-results.csv' });
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  function clearAll(){
    seen.clear(); rows = []; tableBody.innerHTML = ''; bumpCount();
  }

  function toast(msg){
    const t = document.createElement('div');
    t.textContent = msg;
    Object.assign(t.style, { position:'fixed', bottom:'20px', left:'50%', transform:'translateX(-50%)', background:'#0e1631', color:'#e6ecff', padding:'10px 14px', border:'1px solid #233163', borderRadius:'12px', boxShadow:'0 10px 30px rgba(0,0,0,.4)', zIndex:9999, opacity:'0', transition:'opacity .2s ease' });
    document.body.appendChild(t);
    requestAnimationFrame(()=>{ t.style.opacity='1'; });
    setTimeout(()=>{ t.style.opacity='0'; setTimeout(()=>t.remove(), 250); }, 1200);
  }

  // Drag & drop images support
  const dropZone = document.body;
  dropZone.addEventListener('dragover', e=>{ e.preventDefault(); });
  dropZone.addEventListener('drop', async e=>{
    e.preventDefault();
    if (!e.dataTransfer || !e.dataTransfer.files?.length) return;
    await scanFiles(Array.from(e.dataTransfer.files));
  });

async function scanFiles(files){
  for (const file of files){
    if (!file.type.startsWith('image/')) continue;
    try {
      console.log("ðŸ“‚ Scanning file:", file.name, file.type, file.size, "bytes");

      const r = await html5Qr.scanFileV2(file, true);
      console.log("ðŸ”Ž Raw scanFileV2 result:", r);

      if (Array.isArray(r)) {
        console.log(`âœ… Found ${r.length} codes in ${file.name}`);
        for (const hit of r){
          const val = String(hit.decodedText || hit.text || '');
          console.log("âž¡ï¸  Code text:", val, "full hit object:", hit);
          if (val){
            if (!dedupeChk.checked || !seen.has(val)){
              if (dedupeChk.checked) seen.add(val);
              addRow(val);
              if (beepChk.checked) beep();
            }
          }
        }
      } else if (r?.decodedText){
        console.log("âœ… Found single code in", file.name, ":", r.decodedText);
        const val = String(r.decodedText);
        if (!dedupeChk.checked || !seen.has(val)){
          if (dedupeChk.checked) seen.add(val);
          addRow(val);
          if (beepChk.checked) beep();
        }
      } else {
        console.log("âš ï¸ No codes found in", file.name);
      }
    } catch(err){
      console.error("âŒ Error scanning", file.name, err);
    }
  }
  toast('Scanned ' + files.length + ' image file(s)');
}


  // UI wiring
  startBtn.addEventListener('click', start);
  pauseBtn.addEventListener('click', pause);
  resumeBtn.addEventListener('click', resume);
  stopBtn.addEventListener('click', stop);
  torchBtn.addEventListener('click', toggleTorch);
  copyBtn.addEventListener('click', copyAll);
  exportBtn.addEventListener('click', exportCSV);
  clearBtn.addEventListener('click', clearAll);
  filePicker.addEventListener('change', e=>scanFiles(Array.from(e.target.files||[])));
  cameraSelect.addEventListener('change', ()=>{ currentDeviceId = cameraSelect.value; if(running) { stop().then(start); } });

  // Boot
  listCameras().then(()=>bumpCount());
})();
// --- PWA service worker registration ---
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js")
    .then(reg => console.log("Service worker registered:", reg))
    .catch(err => console.error("Service worker registration failed:", err));
}
</script>
</body>
</html>
